<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>vue进行CURD操作</title>
    <style type="text/css">
        [v-cloak] {
            display: none
        }

        table {
            border: 1px solid #ccc;
            padding: 0;
            border-collapse: collapse;
            table-layout: fixed;
            margin-top: 10px;
            width: 100%;
        }

        table td,
        table th {
            height: 30px;
            border: 1px solid #ccc;
            background: #fff;
            font-size: 15px;
            padding: 3px 3px 3px 8px;
        }

        table th:first-child {
            width: 30px;
        }

        .container,
        .st {
            width: 1000px;
            margin: 10px auto 0;
            font-size: 13px;
            font-family: 'Microsoft YaHei'
        }

        .container .search {
            font-size: 15px;
            padding: 4px;
        }

        .container .add {
            padding: 5px 15px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 6;
            background: rgba(0, 0, 0, 0.7);
        }

        .overlay td:first-child {
            width: 66px;
        }

        .overlay .con {
            position: absolute;
            width: 420px;
            min-height: 300px;
            background: #fff;
            left: 50%;
            top: 50%;
            -webkit-transform: translate3d(-50%, -50%, 0);
            transform: translate3d(-50%, -50%, 0);
            /*margin-top: -150px;*/
            padding: 20px;
        }
    </style>
    <script type="text/javascript" src="vue.js"></script>
    <script src="axios.min.js"></script>
    <script type="text/javascript" src="jquery-3.4.1.js"></script>

</head>
<body>
<div class="st">
    <h1>vue实现对数据的增删改查(CURD)</h1>
</div>
<div class="container" id="app">
    <div>
        <input type="text" placeholder="search" @input="search" list="cars" class="search">
        <datalist id="cars">
            <option v-for="item in searchlist" :value="item"></option>
        </datalist>
        <input type="button" class="add" @click="add" value="新增">
    </div>
    <div>
        <table>
            <tr>
                <th>id</th>
                <th>用户名</th>
                <th>邮箱</th>
                <th>性别</th>
                <th>省份</th>
                <th>爱好</th>
                <th>操作</th>
            </tr>
            <tr v-cloak v-for="(item, index) of slist">
                <td>{{index+1}}</td>
                <td>{{item.username}}</td>
                <td>{{item.email}}</td>
                <td>{{item.sex}}</td>
                <td>{{item.province}}</td>
<!-- 数组.join(' | ')，一定要让hobby是数组格式而不是String               -->
                <td>{{item.hobby.join(' | ')}}</td>
                <td><a href="javascript:;" @click="showOverlay(index,item.id)">修改</a> | <a href="javascript:;"
                                                                                   @click="del(item.id)">删除</a></td>
            </tr>
        </table>
    </div>
    <model :list='selectedlist' :isactive="isActive" v-cloak @change="changeOverlay" @modify="modify"></model>
</div>
</body>

<script type="text/javascript">
//弹出框
    Vue.component('model', {
        props: ['list', 'isactive'],
        template: '<div class="overlay" v-show="isactive">\n' +
            '                        <div class="con">\n' +
            '                        <h2 class="title">新增 | 修改</h2>\n' +
            '                        <div class="content">\n' +
            '                        <table>\n' +
            '                        <tr>\n' +
            '                        <td>用户名</td>\n' +
            '                        <td><input type="text" v-model="modifylist.username"></td>\n' +
            '                        </tr>\n' +
            '                        <tr>\n' +
            '                        <td>邮箱</td>\n' +
            '                        <td><input type="text" v-model="modifylist.email"></td>\n' +
            '                        </tr>\n' +
            '                        <tr>\n' +
            '                        <td>性别</td>\n' +
            '                        <td>\n' +
            '                        <label><input type="radio" name="sex" value="男" v-model="modifylist.sex">男</label>\n' +
            '                        <label><input type="radio" name="sex" value="女" v-model="modifylist.sex">女</label>\n' +
            '                        <label><input type="radio" name="sex" value="未知" v-model="modifylist.sex">未知</label>\n' +
            '                        </td>\n' +
            '                        </tr>\n' +
            '                        <tr>\n' +
            '                        <td>省份</td>\n' +
            '                        <td>\n' +
            '                        <select name="" id="" v-model="modifylist.province">\n' +
            '                        <option value="北京市">北京市</option>\n' +
            '                        <option value="河北省">河北省</option>\n' +
            '                        <option value="河南省">河南省</option>\n' +
            '                        <option value="重庆市">重庆市</option>\n' +
            '                        <option value="广东省">广东省</option>\n' +
            '                        <option value="辽宁省">辽宁省</option>\n' +
            '                        </select>\n' +
            '                        </td>\n' +
            '                        </tr>\n' +
            '                        <tr>\n' +
            '                        <td>爱好</td>\n' +
            '                        <td>\n' +
            '                        <label><input type="checkbox" v-model="modifylist.hobby" value="篮球">篮球</label>\n' +
            '                        <label><input type="checkbox" v-model="modifylist.hobby" value="读书">读书</label>\n' +
            '                        <label><input type="checkbox" v-model="modifylist.hobby" value="插画">插画</label>\n' +
            '                        <label><input type="checkbox" v-model="modifylist.hobby" value="编程">编程</label>\n' +
            '                        <label><input type="checkbox" v-model="modifylist.hobby" value="弹琴">弹琴</label>\n' +
            '                        </td>\n' +
            '                        </tr>\n' +
            '                        </table>\n' +
            '                        <p>\n' +
            '                        <input type="button" @click="changeActive" value="取消">\n' +
            '                        <input type="button" @click="modify" value="保存">\n' +
            '                        </p>\n' +
            '                        </div>\n' +
            '                        </div>\n' +
            '                    </div>',
        /*-computed vs methods
我们可以使用 methods 来替代 computed，效果上两个都是一样的，
但是 computed 是基于它的依赖缓存，只有相关依赖发生改变时才会重新取值。
而使用 methods ，在重新渲染的时候，函数总会重新调用执行。-*/
        computed: {
            modifylist() {
                return this.list;
            }
        },
        methods: {
            changeActive() {
                this.$emit('change');  //在html自定义的组件名
            },
            modify() {
                this.$emit('modify', this.modifylist);
            }
        }
    });
    var app = new Vue({
    el: '#app',
    data: {
        isActive: false,
        selected: -1,
        index:-1,
        selectedlist: {},
        slist: [],
        searchlist: [],
        list: [],
        username: '',
        email: '',
        sex: '男',
        province: '北京市',
        hobbyStr:'',
        hobby: []
    },
    // data() {
    //     return {
    //         list: null
    //     }
    // },
    mounted() {
        axios
            .get('http://localhost:8080/list')
            .then(response => {
                this.list = response.data;
                console.log(this.list);
                //循环加入hobby
                for (var i=0;i<this.list.length;i++){
                    this.hobby.push(this.list[i].hobby.split(","));
                    this.list[i].hobby=this.list[i].hobby.split(",");
                }
                this.setSlist(response.data);
                console.log(this.hobby);
            })
            .catch(function (error) { // 请求失败处理
                console.log(error);
            });
    },
    created() {
        this.setSlist(this.list);
    },
    methods: {
        // 修改数据
        showOverlay(index,id) {
            this.index = index;    //选择修改条目的索引
            this.selected=id;
            console.log(this.index+'  '+this.selected);
            this.selectedlist = this.list[index];   //显示所选条目的所有信息   暂且修改前3
            this.changeOverlay();    //修改完关闭model

        },
        // 点击保存按钮
        modify(arr) {
            console.log(this.selected);
            if (this.selected > -1) {    //修改
                Vue.set(this.list, this.index, arr);
                //console.log(this.list);
                //POST到数据库
                axios.post('http://localhost:8080/update', {
                    id:this.selected,
                    username: arr.username,                  // 参数 firstName
                    email: arr.email,    // 参数 lastName
                    sex:arr.sex,
                    province:arr.province,
                    hobby:arr.hobby.toString()
                })
                    .then(function (response) {
                        console.log(response);
                        console.log(this.hobby);
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
                this.selected = -1;
            } else {                    //新增

                //POST到数据库
                axios.post('http://localhost:8080/insert', {
                    username: arr.username,                  // 参数 firstName
                    email: arr.email,    // 参数 lastName
                    sex:arr.sex,
                    province:arr.province,
                    hobby:arr.hobby.toString()
                })
                    .then(function (response) {
                        window.location.reload();
                        console.log(response);
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
            }
            this.setSlist(this.list);
            this.changeOverlay();   //点击保存后关闭model
        },
        add: function () {
            this.selectedlist = {
                username: '',
                email: '',
                sex: '男',
                province: '北京市',
                hobby: []
            };
            this.isActive = true;
        },
        // delete list in index location
        del(index) {
            if(confirm("确定删除吗？")){
                //POST到数据库  删除

                this.list.splice(index, 1);
                this.setSlist(this.list);
                axios.post('http://localhost:8080/delete/'+index, {
                })
                    .then(function (response) {
                        window.location.reload();
                        console.log(response);
                    })
                    .catch(function (error) {
                        console.log(error);
                    });
            }
        },
        changeOverlay() {  //点击关闭按钮
            //this.selected = -1;
            this.isActive = !this.isActive;    //关闭model，true->false
        },
        // 获取需要渲染到页面中的数据
        setSlist(arr) {
            this.slist = JSON.parse(JSON.stringify(arr));
            // this.list = arr;
            // console.log(this.hobby);
        },
        // 搜索
        search(e) {
            var v = e.target.value,
                self = this;
            self.searchlist = [];
            if (v) {
                var ss = [];
                // 过滤需要的数据
                this.list.forEach(function (item) {
                    if (item.username.indexOf(v) > -1) {
                        if (self.searchlist.indexOf(item.username) == -1) {
                            self.searchlist.push(item.username);
                        }
                        ss.push(item);
                    } else if (item.email.indexOf(v) > -1) {
                        if (self.searchlist.indexOf(item.email) == -1) {
                            self.searchlist.push(item.email);
                        }
                        ss.push(item);
                    }
                });
                this.setSlist(ss); // 将过滤后的数据给了slist
            } else {
                // 没有搜索内容，则展示全部数据
                this.setSlist(this.list);
            }
        }
    },
    watch: {
    }
})
   </script>
</html>